<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç´ é—®æŠ¢ç­”æ¨¡æ‹Ÿ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <script src="avatar-generator.js"></script>
    <script src="avatar-selector.js"></script>
    <script src="game-state-manager.js"></script>
    <script src="animation-manager.js"></script>
    <script src="ui-controller.js"></script>
  
  <!-- ä¸»æ¸¸æˆå®¹å™¨ -->
  <div class="quiz-container">
    <!-- åŠ åˆ†åŠ¨ç”»å®¹å™¨ï¼šç”¨äºæ˜¾ç¤ºåˆ†æ•°å¢åŠ æ—¶çš„é£è¡ŒåŠ¨ç”»æ•ˆæœ -->
    <div class="score-animation-container" id="score-animation-container"></div>
    
    <!-- é¡¶éƒ¨çŠ¶æ€æ ï¼šæ˜¾ç¤ºç©å®¶ä¿¡æ¯ã€è®¡æ—¶å™¨ã€å¯¹æ‰‹ä¿¡æ¯ -->
    <div class="header">
      <!-- ç©å®¶ä¿¡æ¯åŒºåŸŸ -->
      <div class="player-info">
        <div class="avatar">You</div>
        <div class="player-score">0</div>
      </div>
      
      <!-- è®¡æ—¶å™¨åŒºåŸŸï¼šæ˜¾ç¤ºå½“å‰é¢˜ç›®å‰©ä½™æ—¶é—´ -->
      <div class="timer-container">
        <div class="timer-circle">
          <!-- è®¡æ—¶å™¨è¿›åº¦åœ†ç¯ -->
          <div class="timer-progress"></div>
          <!-- è®¡æ—¶å™¨æ•°å­—æ˜¾ç¤º -->
          <span style="position: relative; z-index: 1;">0</span>
        </div>
      </div>
      
      <!-- å¯¹æ‰‹ä¿¡æ¯åŒºåŸŸ -->
      <div class="opponent-info">
        <div class="opponent-score">
          <div class="score-number">0</div>
        </div>
        <div class="opponent-avatar"></div>
      </div>
    </div>

    <!-- è½®æ¬¡æç¤ºæ–‡æœ¬ï¼šæ˜¾ç¤ºå½“å‰é¢˜ç›®è½®æ¬¡æˆ–æ¸¸æˆçŠ¶æ€ -->
    <div class="rank-text" id="rank-text"></div>
    
    <!-- é¢˜ç›®åŒºåŸŸï¼šåŒ…å«é¢˜ç›®å†…å®¹ã€é€‰é¡¹ã€è¿›åº¦æ¡ -->
    <div class="question-section">
      <!-- å·¦ä¾§è¿›åº¦æ¡ï¼šæ˜¾ç¤ºç©å®¶å½“å‰åˆ†æ•°è¿›åº¦ -->
      <div class="progress-bar left-progress">
        <div class="progress-fill" id="left-progress-fill"></div>
      </div>
      
      <!-- é¢˜ç›®å†…å®¹åŒºåŸŸ -->
      <div class="question-content">
        <!-- é¢˜ç›®æ–‡æœ¬ -->
        <div class="question-text">
          å½“ä¸€ä¸ªäººè®¤ä¸º"äººäººéƒ½åœ¨æ¬ºè´Ÿæˆ‘"æ—¶,æœ€éœ€è¦åæ€çš„æ˜¯ä»€ä¹ˆ?
        </div>
        
        <!-- é€‰é¡¹å®¹å™¨ï¼šåŒ…å«4ä¸ªç­”é¢˜é€‰é¡¹ -->
        <div class="options-container">
          <!-- é€‰é¡¹1ï¼šåŒ…å«é€‰é¡¹æ–‡æœ¬å’Œå¯¹æ‰‹ç»“æœå›¾æ ‡ -->
          <div class="option" data-option="1">
            <div class="option-text">ç¤¾ä¼šç¼ºä¹å¯¹å¼±è€…çš„ä¿æŠ¤æœºåˆ¶</div>
            <div class="opponent-result" data-option="1"></div>
          </div>
          
          <!-- é€‰é¡¹2 -->
          <div class="option" data-option="2">
            <div class="option-text">æ˜¯å¦ä¾µçŠ¯äº†taäººçš„åˆæ³•è‡ªç”±</div>
            <div class="opponent-result" data-option="2"></div>
          </div>
          
          <!-- é€‰é¡¹3 -->
          <div class="option" data-option="3">
            <div class="option-text">è‡ªèº«å®åŠ›å¼±å°,æ— æ³•å½¢æˆæœ‰æ•ˆå¨æ…‘</div>
            <div class="opponent-result" data-option="3"></div>
          </div>
          
          <!-- é€‰é¡¹4 -->
          <div class="option" data-option="4">
            <div class="option-text">taäººæ™®éå­˜åœ¨çš„æ•Œæ„</div>
            <div class="opponent-result" data-option="4"></div>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§è¿›åº¦æ¡ï¼šæ˜¾ç¤ºå¯¹æ‰‹å½“å‰åˆ†æ•°è¿›åº¦ -->
      <div class="progress-bar right-progress">
        <div class="progress-fill" id="right-progress-fill"></div>
      </div>
    </div>
    <!-- ç»“æŸç•Œé¢ï¼šæ˜¾ç¤ºèƒœè´Ÿé¢œæ–‡å­—ä¸ç»§ç»­æŒ‘æˆ˜æŒ‰é’® -->
    <div class="end-screen" id="end-screen" style="display: none;">
      <div class="end-title" id="end-title">å¹³å±€</div>
      <div class="end-emoji" id="end-emoji">(-__-Â°)</div>
      <button class="cta-button primary" id="continue-button">ç»§ç»­æŒ‘æˆ˜</button>
    </div>
    
  </div>

    <!-- åº•éƒ¨é¢˜åº“æ¥æºå£°æ˜ -->
    <div class="footer-attribution">
      <p>é¢˜åº“æ¥æºï¼š<a href="https://sooon.ai/" target="_blank">ç´ é—®</a>ï¼Œè¯¦è§
        <a href="about.html" >å…³äº</a> ,å¯ä»¥é€šè¿‡
        <a href="#" id="settings-link">è®¾ç½®</a> ä¿®æ”¹ç­”é¢˜ AI è¡¨ç°
      </p>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="settings-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>æ¸¸æˆè®¾ç½®</h3>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- å¤´åƒè®¾ç½®åŒºåŸŸ -->
          <div class="setting-group">
            <label class="setting-label">å¤´åƒè®¾ç½®</label>
            <div class="avatar-settings">
              <div class="avatar-setting-item">
                <div class="avatar-preview" id="user-avatar-preview">
                  <div class="avatar">You</div>
                </div>
                <div class="avatar-info">
                  <div class="avatar-name">ç”¨æˆ·å¤´åƒ</div>
                  <button class="btn btn-outline" id="change-user-avatar">ä¿®æ”¹ç”¨æˆ·å¤´åƒ</button>
                </div>
              </div>
              <div class="avatar-setting-item">
                <div class="avatar-preview" id="ai-avatar-preview">
                  <div class="opponent-avatar"></div>
                </div>
                <div class="avatar-info">
                  <div class="avatar-name">AIå¤´åƒ</div>
                  <button class="btn btn-outline" id="change-ai-avatar">ä¿®æ”¹AIå¤´åƒ</button>
                </div>
              </div>
            </div>
            <div class="setting-description">ç‚¹å‡»ä¿®æ”¹ç”¨æˆ·æˆ–AIçš„å¤´åƒï¼Œæ”¯æŒè‡ªå®šä¹‰å¤´åƒå’Œéšæœºç”Ÿæˆã€‚</div>
          </div>
          
          <!-- AIè®¾ç½®åŒºåŸŸ -->
          <div class="setting-group">
            <label class="setting-label">AIæ­£ç¡®ç‡ (%)</label>
            <input type="number" id="ai-accuracy" class="setting-input" placeholder="è¯·è¾“å…¥0-100çš„æ•°å­—" min="0" max="100" step="1" pattern="[0-9]*" inputmode="numeric">
            <div class="setting-description">è®¾ç½®AIç­”é¢˜çš„æ­£ç¡®ç‡ï¼Œ0%è¡¨ç¤ºæ€»æ˜¯ç­”é”™ï¼Œ100%è¡¨ç¤ºæ€»æ˜¯ç­”å¯¹ã€‚ä»…å…è®¸è¾“å…¥æ•°å­—ã€‚</div>
          </div>
          
          <div class="setting-group">
            <label class="setting-label">AIé€Ÿåº¦èŒƒå›´ (æ¯«ç§’)</label>
            <div class="speed-inputs">
              <input type="number" id="ai-speed-min" class="setting-input" placeholder="æœ€å°æ•°å­—" min="100" max="5000" step="100" pattern="[0-9]*" inputmode="numeric">
              <span class="speed-separator">-</span>
              <input type="number" id="ai-speed-max" class="setting-input" placeholder="æœ€å¤§æ•°å­—" min="100" max="5000" step="100" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="setting-description">è®¾ç½®AIä½œç­”çš„å»¶è¿Ÿæ—¶é—´èŒƒå›´ï¼Œä»…å…è®¸è¾“å…¥100-5000ä¹‹é—´çš„æ•°å­—ã€‚</div>
          </div>
          
          <!-- å¤´åƒå›ºå®šè®¾ç½® -->
          <div class="setting-group">
            <label class="setting-label">å¤´åƒè®¾ç½®</label>
            <div class="checkbox-setting">
              <input type="checkbox" id="fix-opponent-avatar" class="setting-checkbox">
              <label for="fix-opponent-avatar" class="checkbox-label">å›ºå®šå¯¹æ‰‹å¤´åƒ</label>
            </div>
            <div class="setting-description">å‹¾é€‰åå¯¹æ‰‹å¤´åƒå°†å›ºå®šä¸å˜ï¼Œä¸å‹¾é€‰åˆ™æ¯å±€æ¸¸æˆå¼€å§‹æ—¶åˆ·æ–°ä¸€æ¬¡å¤´åƒã€‚</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="save-settings">ä¿å­˜è®¾ç½®</button>
          <button class="btn btn-secondary" id="cancel-settings">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- å¤´åƒé€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="avatar-modal">
      <div class="modal-content avatar-modal-content">
        <div class="modal-header">
          <h3>ä¿®æ”¹å¤´åƒ</h3>
          <button class="modal-close" id="avatar-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- å½“å‰å¤´åƒæ˜¾ç¤º -->
          <div class="current-avatar-section">
            <div class="current-avatar-label">å½“å‰å¤´åƒ</div>
            <div class="current-avatar-display" id="current-avatar-display"></div>
          </div>
          
          <!-- å¤´åƒé€‰æ‹©ç½‘æ ¼ -->
          <div class="avatar-grid-section">
            <div class="avatar-grid-label">é€‰æ‹©å¤´åƒ</div>
            <div class="avatar-grid" id="avatar-grid">
              <!-- 4x4å¤´åƒç½‘æ ¼å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <div class="avatar-actions">
            <button class="btn btn-secondary" id="clear-avatar">æ¸…ç©ºé€‰æ‹©</button>
            <button class="btn btn-primary" id="regenerate-avatars">é‡æ–°ç”Ÿæˆ</button>
          </div>
          
          <!-- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ -->
          <div class="avatar-import-export">
            <div class="import-export-label">å¤´åƒç®¡ç†</div>
            <div class="import-export-buttons">
              <button class="btn btn-outline" id="export-avatar">å¯¼å‡ºå¤´åƒ</button>
              <button class="btn btn-outline" id="import-avatar">å¯¼å…¥å¤´åƒ</button>
              <input type="file" id="avatar-file-input" accept=".json" style="display: none;">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancel-avatar">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="save-avatar">ä¿å­˜</button>
        </div>
      </div>
    </div>
  <script>
    /**
     * ç­”é¢˜å¯¹æˆ˜æ¸¸æˆä¸»è„šæœ¬
     * è´Ÿè´£åˆå§‹åŒ–æ¸¸æˆç»„ä»¶å’Œåè°ƒå„æ¨¡å—ä¹‹é—´çš„äº¤äº’
     */
    
    // å…¨å±€å˜é‡ï¼šå­˜å‚¨æ¸¸æˆæ ¸å¿ƒç»„ä»¶å®ä¾‹
    let gameStateManager;  // çŠ¶æ€ç®¡ç†å™¨å®ä¾‹
    let uiController;      // UIæ§åˆ¶å™¨å®ä¾‹

    /**
     * é€‰é¡¹åŠ¨ç”»å®Œæˆäº‹ä»¶å¤„ç†
     * ç¡®ä¿é€‰é¡¹åœ¨CSSåŠ¨ç”»å®Œæˆåæ­£ç¡®æ˜¾ç¤º
     */
    document.querySelectorAll('.option').forEach(option => {
      option.addEventListener('animationend', function() {
        this.classList.add('animate-in');
      });
    });

    /**
     * é¡µé¢åŠ è½½å®Œæˆäº‹ä»¶å¤„ç†
     * åˆå§‹åŒ–æ¸¸æˆç»„ä»¶å¹¶å¼€å§‹æ¸¸æˆæµç¨‹
     */
    document.addEventListener('DOMContentLoaded', function() {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
      
      // 1. åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨å®ä¾‹
      // è´Ÿè´£ç®¡ç†æ¸¸æˆçš„æ‰€æœ‰çŠ¶æ€ï¼šåˆ†æ•°ã€è½®æ¬¡ã€é¢˜ç›®ã€è®¡æ—¶å™¨ç­‰
      gameStateManager = new GameStateManager();
      
      // 2. åˆ›å»ºUIæ§åˆ¶å™¨å®ä¾‹
      // è´Ÿè´£è¿æ¥çŠ¶æ€ç®¡ç†å™¨å’ŒDOMæ“ä½œï¼Œå¤„ç†æ‰€æœ‰UIæ›´æ–°
      uiController = new UIController(gameStateManager);
      
      // 3. è®¾ç½®åˆå§‹æ¸¸æˆçŠ¶æ€
      // æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½è§†ä¸ºä¸€å±€æ–°æ¸¸æˆï¼Œé‡ç½®æ‰€æœ‰åˆ†æ•°
      const initialPlayerScore = 0;    // ç©å®¶åˆå§‹åˆ†æ•°
      const initialOpponentScore = 0;  // å¯¹æ‰‹åˆå§‹åˆ†æ•°
      const initialTimeLeft = 150;     // åˆå§‹å€’è®¡æ—¶ï¼ˆç§’ï¼‰
      
      // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨ä¸­çš„åˆå§‹çŠ¶æ€
      gameStateManager.updateState({
        playerScore: initialPlayerScore,
        opponentScore: initialOpponentScore,
        timeLeft: initialTimeLeft
      });

      // 3.1 é…ç½®å¯¹æ‰‹å‚æ•°ï¼ˆå¤´åƒã€AIå‡†ç¡®ç‡ã€é€‰æ‹©é€Ÿåº¦ï¼‰
      // é¦–å…ˆå°è¯•åŠ è½½ä¿å­˜çš„AIå¤´åƒï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆæ–°çš„
      loadOpponentAvatar();

      // 3.1.1 æ·»åŠ AIå¤´åƒç‚¹å‡»äº‹ä»¶
      const opponentAvatar = document.querySelector('.opponent-avatar');
      if (opponentAvatar && window.avatarSelector) {
        opponentAvatar.style.cursor = 'pointer';
        opponentAvatar.title = 'ç‚¹å‡»ä¿®æ”¹AIå¤´åƒ';
        opponentAvatar.addEventListener('click', () => {
          window.avatarSelector.openModal('opponent');
        });
      }

      // 3.1.2 æ·»åŠ ç”¨æˆ·å¤´åƒç‚¹å‡»äº‹ä»¶å’ŒåŠ è½½ä¿å­˜çš„å¤´åƒ
      const playerAvatar = document.querySelector('.player-info .avatar');
      if (playerAvatar && window.avatarSelector) {
        playerAvatar.style.cursor = 'pointer';
        playerAvatar.title = 'ç‚¹å‡»ä¿®æ”¹ç”¨æˆ·å¤´åƒ';
        playerAvatar.addEventListener('click', () => {
          window.avatarSelector.openModal('player');
        });
        
        // åŠ è½½ä¿å­˜çš„ç”¨æˆ·å¤´åƒ
        loadPlayerAvatar();
      }
      
      // 3.2 åˆå§‹åŒ–è®¾ç½®æ¨¡æ€æ¡†
      initializeSettingsModal();
      
      // 4. ç«‹å³æ›´æ–°UIæ˜¾ç¤º
      // ç¡®ä¿é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ­£ç¡®çš„åˆå§‹çŠ¶æ€
      setTimeout(() => {
        uiController.updatePlayerScore(initialPlayerScore);
        uiController.updateOpponentScore(initialOpponentScore);
        
        uiController.updateTimer(initialTimeLeft);
        // åŒæ­¥ä¸€æ¬¡å¤´åƒæ˜¾ç¤º
        uiController.updateOpponentAvatar(gameStateManager.getState('opponent')?.avatar);
        console.log('UIåˆå§‹åŒ–å®Œæˆï¼Œå€’è®¡æ—¶è®¾ç½®ä¸º', initialTimeLeft, 'ç§’');
      }, 100);
        
      // 5. å¼€å§‹æ–°ä¸€å±€æ¸¸æˆ
      // å»¶è¿Ÿ500mså¼€å§‹æ¸¸æˆï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½å·²æ­£ç¡®åˆå§‹åŒ–
      setTimeout(() => {
        gameStateManager.startNewGame();
        console.log('æ¸¸æˆå¼€å§‹ï¼');
      }, 500);
        
      console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');

      // æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€ï¼šwindow.debugSettle(0|1|2)
      window.debugSettle = function(mode){
        if (!gameStateManager) return;
        if (typeof gameStateManager.debugSettle === 'function') {
          gameStateManager.debugSettle(Number(mode));
        }
      };
      // æ§åˆ¶å°è¾“å‡ºå¤§æç¤ºè¯´æ˜å¯è®¾ç½®çš„mode
      console.log('å¯è®¾ç½®çš„mode: 0-å¹³å±€, 1-ç©å®¶èƒœ, 2-å¯¹æ‰‹èƒœ');
      console.log('æ–¹æ³•ï¼šdebugSettle(0|1|2)');
    });
    
    /**
     * åˆå§‹åŒ–è®¾ç½®æ¨¡æ€æ¡†
     * ä»localStorageåŠ è½½ä¿å­˜çš„çŠ¶æ€ï¼Œå¹¶è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
     */
    function initializeSettingsModal() {
      const settingsLink = document.getElementById('settings-link');
      const settingsModal = document.getElementById('settings-modal');
      const modalClose = document.getElementById('modal-close');
      const cancelSettings = document.getElementById('cancel-settings');
      const saveSettings = document.getElementById('save-settings');
      const speedMinElement = document.getElementById('ai-speed-min');
      const speedMaxElement = document.getElementById('ai-speed-max');
      const accuracyElement = document.getElementById('ai-accuracy');
      const fixAvatarElement = document.getElementById('fix-opponent-avatar');
      
      if (!settingsLink || !settingsModal || !speedMinElement || !speedMaxElement || !accuracyElement || !fixAvatarElement) {
        console.warn('è®¾ç½®æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      // ä»localStorageåŠ è½½ä¿å­˜çš„çŠ¶æ€
      const savedSpeedMin = localStorage.getItem('aiSpeedMin');
      const savedSpeedMax = localStorage.getItem('aiSpeedMax');
      const savedAccuracy = localStorage.getItem('aiAccuracy');
      const savedAvatarFixed = localStorage.getItem('avatarFixed');
      
      const speedMin = savedSpeedMin ? parseInt(savedSpeedMin) : 1280;
      const speedMax = savedSpeedMax ? parseInt(savedSpeedMax) : 2900;
      const accuracy = savedAccuracy ? parseFloat(savedAccuracy) : 0;
      const avatarFixed = savedAvatarFixed ? JSON.parse(savedAvatarFixed) : false;
      
      // è®¾ç½®åˆå§‹å€¼
      speedMinElement.value = speedMin;
      speedMaxElement.value = speedMax;
      accuracyElement.value = accuracy;
      fixAvatarElement.checked = avatarFixed;
      
      // æ›´æ–°å¤´åƒé¢„è§ˆ
      updateAvatarPreviews();
      
      // æ›´æ–°æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ä¸­çš„çŠ¶æ€
      if (gameStateManager) {
        gameStateManager.updateState({ 
          aiSpeedRange: [speedMin, speedMax],
          aiAccuracy: accuracy / 100 // è½¬æ¢ä¸º0-1èŒƒå›´
        });
        // è®¾ç½®å¤´åƒå›ºå®šçŠ¶æ€
        gameStateManager.setAvatarFixed(avatarFixed);
      }
      
      // æ‰“å¼€æ¨¡æ€æ¡†
      function openModal() {
        settingsModal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
      
      // å…³é—­æ¨¡æ€æ¡†
      function closeModal() {
        settingsModal.classList.remove('show');
        document.body.style.overflow = '';
      }
      
      // æ•°æ®éªŒè¯å’Œä¿®æ­£å‡½æ•°
      function validateAndCorrectInputs() {
        let hasError = false;
        
        // éªŒè¯æ­£ç¡®ç‡
        let accuracy = parseFloat(accuracyElement.value);
        if (isNaN(accuracy)) {
          // å¦‚æœè¾“å…¥ä¸ºç©ºæˆ–æ— æ•ˆï¼Œä¿æŒåŸå€¼ä¸è‡ªåŠ¨ä¿®æ­£
          accuracyElement.classList.remove('input-error');
        } else if (accuracy < 0 || accuracy > 100) {
          // è¶…å‡ºèŒƒå›´æ—¶è‡ªåŠ¨ä¿®æ­£å¹¶æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          accuracy = Math.max(0, Math.min(100, accuracy));
          accuracyElement.value = accuracy;
          accuracyElement.classList.add('input-error');
          hasError = true;
        } else {
          accuracyElement.classList.remove('input-error');
        }
        
        // éªŒè¯é€Ÿåº¦èŒƒå›´
        let min = parseInt(speedMinElement.value);
        let max = parseInt(speedMaxElement.value);
        
        if (isNaN(min)) {
          speedMinElement.classList.remove('input-error');
        } else if (min < 100 || min > 5000) {
          min = Math.max(100, Math.min(5000, min));
          speedMinElement.value = min;
          speedMinElement.classList.add('input-error');
          hasError = true;
        } else {
          speedMinElement.classList.remove('input-error');
        }
        
        if (isNaN(max)) {
          speedMaxElement.classList.remove('input-error');
        } else if (max < 100 || max > 5000) {
          max = Math.max(100, Math.min(5000, max));
          speedMaxElement.value = max;
          speedMaxElement.classList.add('input-error');
          hasError = true;
        } else {
          speedMaxElement.classList.remove('input-error');
        }
        
        // ç¡®ä¿æœ€å°å€¼ä¸å¤§äºæœ€å¤§å€¼ï¼ˆä»…åœ¨ä¸¤ä¸ªå€¼éƒ½æœ‰æ•ˆæ—¶æ£€æŸ¥ï¼‰
        if (!isNaN(min) && !isNaN(max) && min > max) {
          const temp = min;
          min = max;
          max = temp;
          speedMinElement.value = min;
          speedMaxElement.value = max;
          speedMinElement.classList.add('input-error');
          speedMaxElement.classList.add('input-error');
          hasError = true;
        }
        
        return { accuracy, min, max, hasError };
      }
      
      // æ•°å­—è¾“å…¥è¿‡æ»¤å‡½æ•°
      function filterNumericInput(element) {
        // ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼ˆåŒ…æ‹¬è´Ÿå·ã€å°æ•°ç‚¹ç­‰ï¼‰
        const originalValue = element.value;
        const numericValue = originalValue.replace(/[^0-9]/g, '');
        
        if (originalValue !== numericValue) {
          element.value = numericValue;
          element.classList.add('input-error');
          
          // æ˜¾ç¤ºè¿‡æ»¤æç¤º
          showCorrectionTip(element, 'ä»…å…è®¸è¾“å…¥æ•°å­—');
          
          // çŸ­æš‚æ˜¾ç¤ºé”™è¯¯çŠ¶æ€åæ¸…é™¤
          setTimeout(() => {
            element.classList.remove('input-error');
          }, 1000);
        }
      }
      
      // é”®ç›˜äº‹ä»¶è¿‡æ»¤å‡½æ•°
      function handleKeyPress(e) {
        const allowedKeys = [
          'Backspace', 'Delete', 'Tab', 'Enter', 'Escape',
          'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
          'Home', 'End'
        ];
        
        // å…è®¸çš„åŠŸèƒ½é”®
        if (allowedKeys.includes(e.key)) {
          return;
        }
        
        // åªå…è®¸æ•°å­—é”®
        if (!/^[0-9]$/.test(e.key)) {
          e.preventDefault();
          showCorrectionTip(e.target, 'ä»…å…è®¸è¾“å…¥æ•°å­—');
        }
      }
      
      // æ™ºèƒ½è¾“å…¥å¤„ç†å‡½æ•°
      function handleSmartInput(element, min, max, defaultValue) {
        // é¦–å…ˆè¿‡æ»¤éæ•°å­—å­—ç¬¦
        filterNumericInput(element);
        
        const value = parseInt(element.value);
        
        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œä¸å¤„ç†
        if (element.value === '') {
          element.classList.remove('input-error');
          return;
        }
        
        // å¦‚æœè¾“å…¥æ— æ•ˆæ•°å­—
        if (isNaN(value)) {
          element.classList.add('input-error');
          return;
        }
        
        // å¦‚æœè¶…å‡ºèŒƒå›´ï¼Œè‡ªåŠ¨ä¿®æ­£
        if (value < min || value > max) {
          const correctedValue = Math.max(min, Math.min(max, value));
          element.value = correctedValue;
          element.classList.add('input-error');
          
          // æ˜¾ç¤ºä¿®æ­£æç¤º
          showCorrectionTip(element, `å·²è‡ªåŠ¨ä¿®æ­£ä¸º ${correctedValue}`);
        } else {
          element.classList.remove('input-error');
        }
      }
      
      // æ˜¾ç¤ºä¿®æ­£æç¤º
      function showCorrectionTip(element, message) {
        // åˆ›å»ºæç¤ºå…ƒç´ 
        let tip = element.parentNode.querySelector('.correction-tip');
        if (!tip) {
          tip = document.createElement('div');
          tip.className = 'correction-tip';
          tip.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            margin-top: 2px;
          `;
          element.parentNode.style.position = 'relative';
          element.parentNode.appendChild(tip);
        }
        
        tip.textContent = message;
        tip.style.display = 'block';
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          tip.style.display = 'none';
        }, 3000);
      }
      
      // å®æ—¶è¾“å…¥ç›‘å¬
      function addInputListeners() {
        // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        [accuracyElement, speedMinElement, speedMaxElement].forEach(element => {
          // é”®ç›˜æŒ‰ä¸‹äº‹ä»¶ç›‘å¬
          element.addEventListener('keydown', handleKeyPress);
          
          // ç²˜è´´äº‹ä»¶ç›‘å¬
          element.addEventListener('paste', function(e) {
            // å»¶è¿Ÿå¤„ç†ç²˜è´´å†…å®¹
            setTimeout(() => {
              filterNumericInput(this);
            }, 10);
          });
        });
        
        // æ­£ç¡®ç‡è¾“å…¥æ¡†ç›‘å¬
        accuracyElement.addEventListener('input', function() {
          handleSmartInput(this, 0, 100, 0);
        });
        
        // é€Ÿåº¦èŒƒå›´è¾“å…¥æ¡†ç›‘å¬
        speedMinElement.addEventListener('input', function() {
          handleSmartInput(this, 100, 5000, 100);
        });
        
        speedMaxElement.addEventListener('input', function() {
          handleSmartInput(this, 100, 5000, 5000);
        });
        
        // å¤±å»ç„¦ç‚¹æ—¶çš„æœ€ç»ˆéªŒè¯å’Œä¿å­˜
        accuracyElement.addEventListener('blur', function() {
          const result = validateAndCorrectInputs();
          if (!result.hasError && !isNaN(result.accuracy)) {
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('aiAccuracy', result.accuracy.toString());
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            if (gameStateManager) {
              gameStateManager.updateState({ 
                aiAccuracy: result.accuracy / 100
              });
            }
          }
        });
        
        speedMinElement.addEventListener('blur', function() {
          const result = validateAndCorrectInputs();
          if (!result.hasError && !isNaN(result.min)) {
            localStorage.setItem('aiSpeedMin', result.min.toString());
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            if (gameStateManager) {
              gameStateManager.updateState({ 
                aiSpeedRange: [result.min, result.max]
              });
            }
          }
        });
        
        speedMaxElement.addEventListener('blur', function() {
          const result = validateAndCorrectInputs();
          if (!result.hasError && !isNaN(result.max)) {
            localStorage.setItem('aiSpeedMax', result.max.toString());
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            if (gameStateManager) {
              gameStateManager.updateState({ 
                aiSpeedRange: [result.min, result.max]
              });
            }
          }
        });
        
        // é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆEnteré”®ä¿å­˜ï¼‰
        [accuracyElement, speedMinElement, speedMaxElement].forEach(element => {
          element.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              const result = validateAndCorrectInputs();
              if (!result.hasError) {
                // è‡ªåŠ¨ä¿å­˜å¹¶æ›´æ–°çŠ¶æ€
                if (this === accuracyElement && !isNaN(result.accuracy)) {
                  localStorage.setItem('aiAccuracy', result.accuracy.toString());
                  if (gameStateManager) {
                    gameStateManager.updateState({ aiAccuracy: result.accuracy / 100 });
                  }
                } else if ((this === speedMinElement || this === speedMaxElement) && 
                          !isNaN(result.min) && !isNaN(result.max)) {
                  localStorage.setItem('aiSpeedMin', result.min.toString());
                  localStorage.setItem('aiSpeedMax', result.max.toString());
                  if (gameStateManager) {
                    gameStateManager.updateState({ aiSpeedRange: [result.min, result.max] });
                  }
                }
              }
            }
          });
        });
      }
      
      // ä¿å­˜è®¾ç½®
      function saveSettingsHandler() {
        const result = validateAndCorrectInputs();
        
        if (result.hasError) {
          // æ˜¾ç¤ºé”™è¯¯æç¤º
          alert('è¯·æ£€æŸ¥è¾“å…¥å€¼æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼š\n- æ­£ç¡®ç‡ï¼š0-100%\n- é€Ÿåº¦èŒƒå›´ï¼š100-5000ms');
          return;
        }
        
        // è·å–å¤´åƒå›ºå®šè®¾ç½®
        const avatarFixed = fixAvatarElement.checked;
        
        // å¦‚æœç”¨æˆ·å‹¾é€‰äº†å›ºå®šå¤´åƒï¼Œä¿å­˜å½“å‰æ˜¾ç¤ºçš„å¤´åƒ
        if (avatarFixed) {
          const currentOpponentAvatar = document.querySelector('.opponent-avatar');
          if (currentOpponentAvatar && currentOpponentAvatar.innerHTML) {
            // è·å–å½“å‰å¤´åƒçš„HTMLå†…å®¹
            const currentAvatarHTML = currentOpponentAvatar.innerHTML;
            
            // æ„é€ å¤´åƒæ•°æ®å¯¹è±¡
            const avatarData = {
              svg: currentAvatarHTML,
              style: 'current',
              seed: 'fixed-' + Date.now(),
              timestamp: Date.now(),
              isFixed: true
            };
            
            // ä¿å­˜å½“å‰å¤´åƒåˆ°localStorage
            localStorage.setItem('sooon-avatar-data', JSON.stringify(avatarData));
            console.log('å·²ä¿å­˜å½“å‰å¤´åƒç”¨äºå›ºå®šæ˜¾ç¤º');
          }
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨
        if (gameStateManager) {
          gameStateManager.updateState({ 
            aiSpeedRange: [result.min, result.max],
            aiAccuracy: result.accuracy / 100 // è½¬æ¢ä¸º0-1èŒƒå›´
          });
          // è®¾ç½®å¤´åƒå›ºå®šçŠ¶æ€
          gameStateManager.setAvatarFixed(avatarFixed);
        }
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('aiSpeedMin', result.min.toString());
        localStorage.setItem('aiSpeedMax', result.max.toString());
        localStorage.setItem('aiAccuracy', result.accuracy.toString());
        localStorage.setItem('avatarFixed', JSON.stringify(avatarFixed));
        
        console.log('AIè®¾ç½®å·²ä¿å­˜ - é€Ÿåº¦èŒƒå›´:', result.min + '-' + result.max + 'ms', 'æ­£ç¡®ç‡:', result.accuracy + '%', 'å¤´åƒå›ºå®š:', avatarFixed ? 'æ˜¯' : 'å¦');
        
        closeModal();
      }
      
      // åˆå§‹åŒ–è¾“å…¥ç›‘å¬
      addInputListeners();
      
      // å¤´åƒä¿®æ”¹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const changeUserAvatarBtn = document.getElementById('change-user-avatar');
      const changeAiAvatarBtn = document.getElementById('change-ai-avatar');
      
      if (changeUserAvatarBtn && window.avatarSelector) {
        changeUserAvatarBtn.addEventListener('click', function() {
          window.avatarSelector.openModal('player');
        });
      }
      
      if (changeAiAvatarBtn && window.avatarSelector) {
        changeAiAvatarBtn.addEventListener('click', function() {
          window.avatarSelector.openModal('opponent');
        });
      }
      
      // äº‹ä»¶ç›‘å¬å™¨
      settingsLink.addEventListener('click', function(e) {
        e.preventDefault();
        openModal();
      });
      
      modalClose.addEventListener('click', closeModal);
      cancelSettings.addEventListener('click', closeModal);
      saveSettings.addEventListener('click', saveSettingsHandler);
      
      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
          closeModal();
        }
      });
      
      // ESCé”®å…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && settingsModal.classList.contains('show')) {
          closeModal();
        }
      });
      
      console.log('è®¾ç½®æ¨¡æ€æ¡†åˆå§‹åŒ–å®Œæˆ');
      console.log('å½“å‰è®¾ç½® - é€Ÿåº¦èŒƒå›´:', speedMin + '-' + speedMax + 'ms', 'æ­£ç¡®ç‡:', accuracy + '%');
    }
    
    /**
     * åŠ è½½ä¿å­˜çš„AIå¤´åƒ
     */
    function loadOpponentAvatar() {
      try {
        // é¦–å…ˆæ£€æŸ¥å¤´åƒå›ºå®šè®¾ç½®
        const savedAvatarFixed = localStorage.getItem('avatarFixed');
        const avatarFixed = savedAvatarFixed ? JSON.parse(savedAvatarFixed) : false;
        
        const savedAvatarData = localStorage.getItem('sooon-avatar-data');
        if (savedAvatarData) {
          const avatarData = JSON.parse(savedAvatarData);
          const opponentAvatar = document.querySelector('.opponent-avatar');
          
          if (opponentAvatar && avatarData.svg) {
            // æ¸…ç©ºé»˜è®¤å†…å®¹å¹¶è®¾ç½®ä¿å­˜çš„å¤´åƒ
            opponentAvatar.innerHTML = '';
            opponentAvatar.insertAdjacentHTML('beforeend', avatarData.svg);
            console.log('AIå¤´åƒå·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½:', avatarData.style, avatarData.seed);
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ä¸­çš„å¤´åƒå’Œå›ºå®šçŠ¶æ€
            if (gameStateManager) {
              gameStateManager.configureOpponent({
                avatar: avatarData.svg,
                avatarFixed: avatarFixed,
                ai: { accuracy: 0, speedMsRange: [1280, 2900] }
              });
            }
            return; // æˆåŠŸåŠ è½½ä¿å­˜çš„å¤´åƒï¼Œç›´æ¥è¿”å›
          }
        }
        
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å¤´åƒï¼Œæ£€æŸ¥æ˜¯å¦å›ºå®šå¤´åƒ
        if (avatarFixed) {
          console.log('å¤´åƒè®¾ç½®ä¸ºå›ºå®šï¼Œä½†æ²¡æœ‰ä¿å­˜çš„å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
          const opponentAvatar = document.querySelector('.opponent-avatar');
          if (opponentAvatar) {
            opponentAvatar.innerHTML = 'ğŸ¤–'; // ä½¿ç”¨é»˜è®¤å¤´åƒ
          }
          // æ›´æ–°æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨
          if (gameStateManager) {
            gameStateManager.configureOpponent({
              avatar: 'ğŸ¤–',
              avatarFixed: avatarFixed,
              ai: { accuracy: 0, speedMsRange: [1280, 2900] }
            });
          }
          return;
        }
        
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å¤´åƒä¸”ä¸å›ºå®šï¼Œç”Ÿæˆæ–°çš„AIå¤´åƒ
        console.log('æœªæ‰¾åˆ°ä¿å­˜çš„AIå¤´åƒä¸”æœªå›ºå®šï¼Œç”Ÿæˆæ–°å¤´åƒ');
        generateNewOpponentAvatar();
      } catch (error) {
        console.error('åŠ è½½AIå¤´åƒå¤±è´¥:', error);
        // å‡ºé”™æ—¶ä¹Ÿç”Ÿæˆæ–°å¤´åƒ
        generateNewOpponentAvatar();
      }
    }

    /**
     * ç”Ÿæˆæ–°çš„AIå¤´åƒ
     */
    function generateNewOpponentAvatar() {
      let aiAvatar = 'ğŸ¤–'; // é»˜è®¤å¤´åƒ
      if (window.avatarGenerator) {
        try {
          // å¼‚æ­¥è®¾ç½®å¤´åƒåˆ°DOMå…ƒç´ 
          window.avatarGenerator.setAvatarToElement('.opponent-avatar').then(avatarData => {
            if (avatarData) {
              aiAvatar = avatarData.svg; // ä½¿ç”¨ç”Ÿæˆçš„SVGå¤´åƒ
              console.log('AIå¤´åƒå·²ç”Ÿæˆï¼Œé£æ ¼:', avatarData.style, 'ç§å­:', avatarData.seed);
              
              // æ›´æ–°æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ä¸­çš„å¤´åƒ
              if (gameStateManager) {
                // æ£€æŸ¥å¤´åƒå›ºå®šè®¾ç½®
                const savedAvatarFixed = localStorage.getItem('avatarFixed');
                const avatarFixed = savedAvatarFixed ? JSON.parse(savedAvatarFixed) : false;
                
                gameStateManager.configureOpponent({
                  avatar: aiAvatar,
                  avatarFixed: avatarFixed,
                  ai: { accuracy: 0, speedMsRange: [1280, 2900] }
                });
              }
            }
          }).catch(error => {
            console.warn('å¤´åƒç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ:', error);
            if (gameStateManager) {
              // æ£€æŸ¥å¤´åƒå›ºå®šè®¾ç½®
              const savedAvatarFixed = localStorage.getItem('avatarFixed');
              const avatarFixed = savedAvatarFixed ? JSON.parse(savedAvatarFixed) : false;
              
              gameStateManager.configureOpponent({
                avatar: aiAvatar,
                avatarFixed: avatarFixed,
                ai: { accuracy: 0, speedMsRange: [1280, 2900] }
              });
            }
          });
        } catch (error) {
          console.warn('å¤´åƒç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ:', error);
        }
      }
      
      // å¦‚æœå¤´åƒç”Ÿæˆå™¨ä¸å¯ç”¨ï¼Œç«‹å³é…ç½®å¯¹æ‰‹
      if (!window.avatarGenerator && gameStateManager) {
        // æ£€æŸ¥å¤´åƒå›ºå®šè®¾ç½®
        const savedAvatarFixed = localStorage.getItem('avatarFixed');
        const avatarFixed = savedAvatarFixed ? JSON.parse(savedAvatarFixed) : false;
        
        gameStateManager.configureOpponent({
          avatar: aiAvatar,
          avatarFixed: avatarFixed,
          ai: { accuracy: 0, speedMsRange: [1280, 2900] }
        });
      }
    }
    
    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨è°ƒç”¨
    window.generateNewOpponentAvatar = generateNewOpponentAvatar;

    /**
     * åŠ è½½ä¿å­˜çš„ç”¨æˆ·å¤´åƒ
     */
    function loadPlayerAvatar() {
      try {
        const savedAvatarData = localStorage.getItem('sooon-player-avatar-data');
        if (savedAvatarData) {
          const avatarData = JSON.parse(savedAvatarData);
          const playerAvatar = document.querySelector('.player-info .avatar');
          
          if (playerAvatar && avatarData.svg) {
            // æ¸…ç©ºé»˜è®¤å†…å®¹å¹¶è®¾ç½®ä¿å­˜çš„å¤´åƒ
            playerAvatar.innerHTML = '';
            playerAvatar.insertAdjacentHTML('beforeend', avatarData.svg);
            console.log('ç”¨æˆ·å¤´åƒå·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½:', avatarData.style, avatarData.seed);
          }
        } else {
          console.log('æœªæ‰¾åˆ°ä¿å­˜çš„ç”¨æˆ·å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·å¤´åƒå¤±è´¥:', error);
      }
    }

    /**
     * æ›´æ–°å¤´åƒé¢„è§ˆ
     */
    function updateAvatarPreviews() {
      // æ›´æ–°ç”¨æˆ·å¤´åƒé¢„è§ˆ
      const userAvatarPreview = document.getElementById('user-avatar-preview');
      const userAvatar = document.querySelector('.player-info .avatar');
      if (userAvatarPreview && userAvatar) {
        userAvatarPreview.innerHTML = userAvatar.innerHTML;
      }
      
      // æ›´æ–°AIå¤´åƒé¢„è§ˆ
      const aiAvatarPreview = document.getElementById('ai-avatar-preview');
      const aiAvatar = document.querySelector('.opponent-avatar');
      if (aiAvatarPreview && aiAvatar) {
        aiAvatarPreview.innerHTML = aiAvatar.innerHTML;
      }
    }
    
    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›å¤´åƒé€‰æ‹©å™¨è°ƒç”¨
    window.updateAvatarPreviews = updateAvatarPreviews;
    
    /**
     * é¡µé¢å¸è½½äº‹ä»¶å¤„ç†
     * æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
     */
    window.addEventListener('beforeunload', function() {
      console.log('é¡µé¢å³å°†å¸è½½ï¼Œå¼€å§‹æ¸…ç†èµ„æº...');
      
      // æ¸…ç†çŠ¶æ€ç®¡ç†å™¨
      if (gameStateManager) {
        gameStateManager.destroy();
        console.log('çŠ¶æ€ç®¡ç†å™¨å·²æ¸…ç†');
      }
      
      // æ¸…ç†UIæ§åˆ¶å™¨
      if (uiController) {
        uiController.destroy();
        console.log('UIæ§åˆ¶å™¨å·²æ¸…ç†');
      }
      
      console.log('èµ„æºæ¸…ç†å®Œæˆ');
    });
  </script>
</body>
</html>